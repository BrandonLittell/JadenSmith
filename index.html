<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>JadenSmith</title>
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link href='http://fonts.googleapis.com/css?family=Josefin+Slab' rel='stylesheet' type='text/css'>   
     <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="./color-thief.min.js"></script>

    <style>
    body {
        font-family: 'Josefin Slab', serif;
        font-size: 48px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="span12">
          <h1>Hi brandon. Hit seearch to start.</h1>
        </div>
        <form class="form-inline">
          <div class="form-group">
            <label class="sr-only">Enter twitter username</label>
              <div class="input-group">
                <div class="input-group-addon">@</div>
                <input type="text" class="form-control" id="userName" value="officaljaden">
              </div>
          </div>
          <button type="button" class="btn btn-primary" id ="searchButton">Search</button>
        </form>
        <div id = "images">
          <div id = "image">
            <canvas id="myCanvas" width="400" height="400"></canvas>
            <br>
            <button type="button" class="btn btn-primary" id ="newImage">New Image</button>
            <div class="btn-group" role="group" aria-label="...">
              <button type="button" class="btn btn-primary active" id ="justifyLeft">Left</button>
              <button type="button" class="btn btn-primary" id ="justifyCenter">Center</button>
              <button type="button" class="btn btn-primary" id ="justifyRight">Right</button>
            </div>
            <button type="button" class="btn btn-primary" id ="download">Download</button>
          </div>
        </div>
          
        <br>
      </div>
    </div>
<script>
var LEFT = true;
var RIGHT = false;
$('#images').hide();
$('#searchButton').click(function(){
  addImage($("#userName").val());
  $('#images').show();
});
$('#newImage').click(function(){
  ImageGenerator.updateImage();
});
$('#justifyRight').click(function(){
  ImageGenerator.generate("RIGHT");
  $("#justifyLeft").attr('class', 'btn btn-primary');
  $("#justifyRight").attr('class', 'btn btn-primary active');
  $("#justifyCenter").attr('class', 'btn btn-primary');
});
$('#justifyLeft').click(function(){
  ImageGenerator.generate("LEFT");
  $("#justifyLeft").attr('class', 'btn btn-primary active');
  $("#justifyRight").attr('class', 'btn btn-primary');
  $("#justifyCenter").attr('class', 'btn btn-primary');
});
$('#justifyCenter').click(function(){
  ImageGenerator.generate("CENTER");
  $("#justifyLeft").attr('class', 'btn btn-primary');
  $("#justifyRight").attr('class', 'btn btn-primary');
  $("#justifyCenter").attr('class', 'btn btn-primary active');
});
//not optimal but works
$('#download').click(function(){
  var dataURL = document.getElementById("myCanvas").toDataURL('image/png');
  window.location.href=dataURL;
})


var ImageGenerator = new Object();
ImageGenerator.init = function(tweetText, authorText, imageSrc) {
  this.canvas = document.getElementById("myCanvas");
  this.context = this.canvas.getContext("2d");
  this.imageWidth = 400;
  this.imageHeight = 400;
  this.textPadding = 20;
  this.tweetText = tweetText;
  this.authorText = authorText;
  this.imageSrc = imageSrc;
}
ImageGenerator.generate = function(justify) {
  var _this = this;
  _this.imageObj = new Image();
  _this.imageObj.crossOrigin="anonymous";
  this.imageObj.src = _this.imageSrc; 
  this.imageObj.onload = function(){
    _this.context.drawImage(_this.imageObj, 0, 0, _this.imageWidth, _this.imageHeight);
    var fontSize = 80 - (_this.tweetText.length /2);
    _this.context.font = fontSize + "px Georgia";
    _this.context.strokeStyle = getInverseColor(_this.canvas);
    _this.context.fillStyle = "white";

      // Write Text
    wrapText(_this.context, _this.tweetText, _this.textPadding, 60, _this.imageWidth - (_this.textPadding * 2), fontSize, justify);
     _this.context.font = "30px Georgia";
    var authorSize = _this.context.measureText(_this.authorText)
    var width = 400 - authorSize.width - (_this.textPadding);
    _this.context.lineWidth = 2.5;
    //_this.context.stroke();
    _this.context.fillText(_this.authorText, width, 380);
    //_this.context.strokeText(_this.authorText, width, 380);

  };

  _this.imageObj.src = _this.imageSrc; 
}

//todo: have some sort of stack to pull new images from
ImageGenerator.updateImage = function(){
  var _this = this;
  _this.context.clearRect(0, 0 ,_this.imageWidth, _this.imageHeight);

  _this.imageSrc = ImageStack.getImage();
  _this.imageObj.src = _this.imageSrc; 
  //ImageGenerator.generate("LEFT");
}

function addImage(username){
  var newImageButton = '';
  $("body").after(newImageButton);
  var tweet = "Jaden Jaden Let Me Twerk On You ONE Time";
  var user = "@officialjaden";
  var image = ImageStack.getImage();

  ImageGenerator.init(tweet, user, image);
  ImageGenerator.generate("LEFT");
}
// From: http://www.html5canvastutorials.com/tutorials/html5-canvas-wrap-text-tutorial/
function wrapText(context, text, x, y, maxWidth, lineHeight, justify) {
  var words = text.split(' ');
  var line = '';
  for(var n = 0; n < words.length; n++) {
    var testLine = line + words[n] + ' ';
    var metrics = context.measureText(testLine);
    var testWidth = metrics.width;
    if (testWidth > maxWidth && n > 0) {
      context.fillText(line, getX(justify, x, line, context), y);
      context.strokeText(line, getX(justify, x, line, context), y);
      line = words[n] + ' ';
      y += lineHeight;
    }
    else {
      line = testLine;
    }
  }
  context.fillText(line, getX(justify, x, line, context), y);
  context.strokeText(line, getX(justify, x, line, context), y);

}
function getX(justify, x, line, context){
  switch(justify){
    case "LEFT":
      return x;  
    case "RIGHT":
      return ImageGenerator.imageWidth - x - context.measureText(line).width;         
    case "CENTER":
      return (ImageGenerator.imageWidth - x - context.measureText(line).width) / 2;      
    }
  }

var ImageStack = new Object();
ImageStack.getImage = function() {
  var imageToReturn = imagesForStack.pop();
  imagesForStack.unshift(imageToReturn);
  return imageToReturn;
}
function getHex(values){
    var red = values[0];
    var green = values[1];
    var blue = values[2];
    var rgb = blue | (green << 8) | (red << 16);
    return "#" + rgb.toString(16);
}
function invertColor(hexTripletColor) {
    var color = hexTripletColor;
    color = color.substring(1);           // remove #
    color = parseInt(color, 16);          // convert to integer
    color = 0xFFFFFF ^ color;             // invert three bytes
    color = color.toString(16);           // convert to hex
    color = ("000000" + color).slice(-6); // pad with leading zeros
    color = "#" + color;                  // prepend #
    return color;
}
function getInverseColor(canvas){
  var colorThief = new ColorThief();
  var color = getHex(colorThief.getColor(canvas));
  return invertColor(color);
}
// this is just one query to images
var imagesForStack = ["https://scontent.cdninstagram.com/hphotos-xaf1/t51.2885-15/s640x640/e35/sh0.08/11420932_1644094922492443_595352985_n.jpg","https://scontent.cdninstagram.com/hphotos-xfp1/t51.2885-15/s640x640/e35/sh0.08/10725181_1446608312330215_1454662323_n.jpg","https://scontent.cdninstagram.com/hphotos-xaf1/t51.2885-15/s640x640/e35/sh0.08/11248975_1128304283852876_2089814245_n.jpg","https://scontent.cdninstagram.com/hphotos-xaf1/t51.2885-15/s640x640/e35/sh0.08/11426229_788284384604035_674378447_n.jpg","https://scontent.cdninstagram.com/hphotos-xaf1/t51.2885-15/e15/11355214_112789875729359_2011113777_n.jpg","https://scontent.cdninstagram.com/hphotos-xaf1/t51.2885-15/s640x640/e35/sh0.08/11242272_1614740678804265_983014268_n.jpg","https://scontent.cdninstagram.com/hphotos-xfa1/t51.2885-15/s640x640/e35/sh0.08/11382944_860348607372694_790343067_n.jpg","https://scontent.cdninstagram.com/hphotos-xaf1/l/t51.2885-15/s640x640/e35/sh0.08/11296672_469178303255162_1233511325_n.jpg","https://scontent.cdninstagram.com/hphotos-xaf1/t51.2885-15/s640x640/e35/sh0.08/11251006_1447925222178817_1546834133_n.jpg","https://scontent.cdninstagram.com/hphotos-xaf1/t51.2885-15/s640x640/e35/sh0.08/11379012_591431260995754_54037340_n.jpg","https://scontent.cdninstagram.com/hphotos-xaf1/t51.2885-15/s640x640/e15/11355280_1658052561080612_512347973_n.jpg","https://scontent.cdninstagram.com/hphotos-xfa1/t51.2885-15/s640x640/e35/sh0.08/11377967_989337941096852_1410326726_n.jpg","https://scontent.cdninstagram.com/hphotos-xaf1/t51.2885-15/s640x640/e35/sh0.08/11379933_415545991979954_593035581_n.jpg","https://scontent.cdninstagram.com/hphotos-xaf1/t51.2885-15/s640x640/e35/sh0.08/11377662_133801170285884_1336436174_n.jpg","https://scontent.cdninstagram.com/hphotos-xaf1/t51.2885-15/s640x640/e35/sh0.08/11385213_889367941130499_744669579_n.jpg","https://scontent.cdninstagram.com/hphotos-xaf1/l/t51.2885-15/s640x640/e35/sh0.08/11373789_504631516358632_160388150_n.jpg","https://scontent.cdninstagram.com/hphotos-xaf1/t51.2885-15/s640x640/e35/sh0.08/11359012_1594482760813180_1109799520_n.jpg","https://scontent.cdninstagram.com/hphotos-xaf1/t51.2885-15/s640x640/e35/sh0.08/11363646_868288236589063_2068054697_n.jpg","https://scontent.cdninstagram.com/hphotos-xaf1/t51.2885-15/e15/11372398_1609473662667485_459261448_n.jpg","https://scontent.cdninstagram.com/hphotos-xaf1/t51.2885-15/e15/11376357_1623817521207219_1000371392_n.jpg"];
</script>
</body>
</html>